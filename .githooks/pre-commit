#!/bin/sh
#
# Pre-commit hook: auto-increment version in pubspec.yaml
# Versioning scheme: <major>.<minor>.<patch>+<build>
# Each commit bumps patch and build by 1.

PUBSPEC=pubspec.yaml

# Get current version from working copy
VERSION_LINE=$(grep '^version:' $PUBSPEC | tr -d '\r')
if [ -z "$VERSION_LINE" ]; then
    echo "Error: Could not find version in $PUBSPEC"
    exit 1
fi

# Get version from last commit to detect if already bumped
HEAD_VERSION=$(git show HEAD:$PUBSPEC 2>/dev/null | grep '^version:' | tr -d '\r' | sed 's/version: //')
CURRENT_VERSION=$(echo "$VERSION_LINE" | sed 's/version: //')

if [ -n "$HEAD_VERSION" ] && [ "$HEAD_VERSION" != "$CURRENT_VERSION" ]; then
    echo "Version already changed: $HEAD_VERSION -> $CURRENT_VERSION (skipping bump)"
    git add $PUBSPEC
    exit 0
fi

VERSION_NAME=$(echo "$CURRENT_VERSION" | cut -d'+' -f1)
BUILD_NUMBER=$(echo "$CURRENT_VERSION" | cut -d'+' -f2)

MAJOR=$(echo "$VERSION_NAME" | cut -d'.' -f1)
MINOR=$(echo "$VERSION_NAME" | cut -d'.' -f2)
PATCH=$(echo "$VERSION_NAME" | cut -d'.' -f3)

NEW_PATCH=$((PATCH + 1))
NEW_BUILD=$((BUILD_NUMBER + 1))
NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}+${NEW_BUILD}"

sed -i "s/^version: .*/version: ${NEW_VERSION}/" $PUBSPEC

git add $PUBSPEC

echo "Version bumped: ${CURRENT_VERSION} -> ${NEW_VERSION}"
